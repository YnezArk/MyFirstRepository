<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的笔记</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .note {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        button {
            margin: 5px;
            padding: 6px 12px;
            cursor: pointer;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        button:hover {
            background-color: #e0e0e0;
        }
        #addNoteForm {
            margin: 20px 0;
            padding: 15px;
            border: 1px dashed #999;
            background-color: #fafafa;
            border-radius: 4px;
        }
        input, textarea {
            padding: 6px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: inherit;
        }
        input[type="text"] {
            width: 300px;
        }
        textarea {
            width: 300px;
            height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
<h2>我的笔记</h2>

<!-- 新增笔记区域 -->
<div id="addNoteForm">
    <h3>添加新笔记</h3>
    <input type="text" id="newTitle" placeholder="请输入标题" maxlength="100">
    <br>
    <textarea id="newContent" placeholder="请输入内容"></textarea>
    <br>
    <button onclick="addNote()">保存笔记</button>
</div>

<!-- 控制按钮 -->
<button onclick="loadNotes()">刷新</button>
<button onclick="window.location.href='/login'">退出登录</button>

<div id="notesContainer"></div>

<script>
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
    }

    // 新增笔记
    async function addNote() {
        const title = document.getElementById('newTitle').value.trim();
        const content = document.getElementById('newContent').value.trim();

        if (!title || !content) {
            alert("标题和内容不能为空！");
            return;
        }

        try {
            const res = await fetch('/api/notes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ title, content })
            });

            if (res.ok) {
                document.getElementById('newTitle').value = '';
                document.getElementById('newContent').value = '';
                loadNotes();
            } else {
                const err = await res.json().catch(() => ({}));
                alert("保存失败：" + (err.message || "未知错误"));
            }
        } catch (e) {
            alert("网络错误：" + e.message);
        }
    }

    // 加载笔记列表
    async function loadNotes() {
        const container = document.getElementById('notesContainer');
        container.innerHTML = '<p>加载中……</p>';

        try {
            const res = await fetch('/api/notes', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const notes = await res.json();

            container.innerHTML = '';
            if (notes.length === 0) {
                container.innerHTML = '<p>暂无笔记。</p>';
                return;
            }

            notes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note';

                // 简单转义防止 XSS（生产环境建议使用 DOMPurify）
                const escapeHtml = str => str.replace(/[<>&"]/g, m =>
                    ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[m] || m)
                );

                const safeTitle = escapeHtml(note.title);
                const safeContent = escapeHtml(note.content);
                const createdAt = note.created_at ? new Date(note.created_at).toLocaleString('zh-CN') : '';

                div.innerHTML = `
                    <h3>${safeTitle}</h3>
                    <p>${safeContent}</p>
                    <small>创建时间：${createdAt}</small>
                    <br>
                    <button onclick="editNote(${note.id})">编辑</button>
                    <button onclick="deleteNote(${note.id})">删除</button>
                `;
                container.appendChild(div);
            });
        } catch (e) {
            container.innerHTML = `<p>加载笔记失败：${e.message}</p>`;
        }
    }

    // 编辑笔记
    async function editNote(id) {
        const title = prompt("请输入新标题：");
        const content = prompt("请输入新内容：");
        if (!title || !content) return;

        try {
            const res = await fetch(`/api/notes/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ title, content })
            });
            if (res.ok) {
                loadNotes();
            } else {
                alert("更新失败");
            }
        } catch (e) {
            alert("更新失败：" + e.message);
        }
    }

    // 删除笔记
    async function deleteNote(id) {
        if (!confirm("确定要删除这条笔记吗？")) return;

        try {
            const res = await fetch(`/api/notes/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                loadNotes();
            } else {
                alert("删除失败");
            }
        } catch (e) {
            alert("删除失败：" + e.message);
        }
    }

    // 初始加载
    loadNotes();
</script>
</body>
</html>